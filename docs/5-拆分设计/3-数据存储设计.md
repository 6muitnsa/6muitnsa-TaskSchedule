# 数据存储设计

## 1. 本地存储模块

### 1.1 功能描述
- SQLite数据库管理
- 数据备份和恢复
- 数据迁移
- 数据同步

### 1.2 数据库设计
1. 任务表（tasks）
```sql
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    priority INTEGER NOT NULL,
    status TEXT NOT NULL,
    start_time DATETIME,
    end_time DATETIME,
    estimated_duration INTEGER,
    rest_time INTEGER,
    period_type TEXT,
    completion_count INTEGER,
    time_slot TEXT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL
);
```

2. 标签表（tags）
```sql
CREATE TABLE tags (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    created_at DATETIME NOT NULL
);
```

3. 任务标签关联表（task_tags）
```sql
CREATE TABLE task_tags (
    task_id TEXT NOT NULL,
    tag_id TEXT NOT NULL,
    PRIMARY KEY (task_id, tag_id),
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    FOREIGN KEY (tag_id) REFERENCES tags(id)
);
```

4. 时间块表（time_blocks）
```sql
CREATE TABLE time_blocks (
    id TEXT PRIMARY KEY,
    start_time DATETIME NOT NULL,
    end_time DATETIME NOT NULL,
    type TEXT NOT NULL,
    task_id TEXT,
    status TEXT NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);
```

### 1.3 接口设计
```typescript
interface LocalStorage {
  initialize(): Promise<void>;
  backup(): Promise<void>;
  restore(backup: Backup): Promise<void>;
  migrate(version: string): Promise<void>;
  sync(): Promise<void>;
}
```

## 2. 服务端存储模块

### 2.1 功能描述
- MySQL数据库管理
- 数据同步服务
- 数据统计分析
- AI训练数据管理

### 2.2 数据库设计
1. 用户表（users）
```sql
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    device_id TEXT NOT NULL UNIQUE,
    created_at DATETIME NOT NULL,
    last_sync_at DATETIME
);
```

2. 任务统计表（task_statistics）
```sql
CREATE TABLE task_statistics (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    task_id TEXT NOT NULL,
    completion_time DATETIME,
    actual_duration INTEGER,
    satisfaction INTEGER,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

3. 调度结果表（schedule_results）
```sql
CREATE TABLE schedule_results (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    algorithm_type TEXT NOT NULL,
    schedule_data JSON NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 2.3 接口设计
```typescript
interface ServerStorage {
  syncUserData(userId: string, data: SyncData): Promise<void>;
  getStatistics(userId: string): Promise<Statistics>;
  saveScheduleResult(result: ScheduleResult): Promise<void>;
  getTrainingData(): Promise<TrainingData>;
}
```

### 2.4 数据同步策略
1. 同步触发条件
   - 定时同步
   - 手动同步
   - 数据变更同步

2. 同步内容
   - 任务数据
   - 时间块数据
   - 统计数据
   - 配置数据

3. 冲突处理
   - 时间戳比较
   - 版本控制
   - 合并策略 